/*  ZotCurve - A tool for UCI students to look at the grade distributions of classes prior.
    Copyright (C) 2019  ZotCurve

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
function sum(t){let e=0;for(let a=0;a<t.length;a++)e+=t[a];return e}function capitalizeName(t){let e=t.split(" "),a="";for(let t=0;t<e.length;t++)e[t].length>0&&(a+=e[t][0].toUpperCase()+e[t].slice(1).toLowerCase()+" ");return a}function trimSelect(t,e,a){let r=[];if("All"==a)return t;for(let n=0;n<t.length;n++)a==t[n][e]&&r.push(t[n]);return r}function numberMatch(t,e){keys=t.split(","),numre=new RegExp(/^\d+$/),numletre=new RegExp(/^\d+[A-Za-z]+$/),rangere=new RegExp(/^\d+-\d+$/);for(let a=0;a<keys.length;a++)try{if(keys[a]=keys[a].replace(/\s/g,""),keys[a].match(numre)){let r=Number(e.replace(/[A-Za-z]*/g,""));if(t[a]==r)return!0}else if(keys[a].match(numletre)){if(keys[a].toUpperCase()==e)return!0}else if(keys[a].match(rangere)){let r=Number(e.replace(/[A-Za-z]*/g,"")),n=t[a].split("-"),l=Number(n[0]),s=Number(n[1]);if(l<=r&&r<=s)return!0}}catch(t){console.log("number match had error in data input")}return!1}function trimNumberInput(t,e,a){let r=[];if(""==a.trim())return t;for(let n=0;n<t.length;n++)numberMatch(a,t[n][e])&&r.push(t[n]);return r}function trimStringInput(t,e,a){let r=[];if(""==(a=a.trim().toLowerCase()))return t;for(let n=0;n<t.length;n++)t[n][e].toLowerCase().includes(a)&&r.push(t[n]);return r}function trimTSV(t){return t=trimSelect(t,0,$("#yearSelect").val()),t=trimSelect(t,1,$("#termSelect").val()),t=trimNumberInput(t=trimSelect(t,2,$("#departmentSelect").val()),3,$("#courseNumberInput").val()),t=trimStringInput(t=trimNumberInput(t,4,$("#courseCodeInput").val()),8,$("#instructorInput").val()),t=trimStringInput(t,6,$("#courseTitleInput").val())}function determineGrades(t){let e=t.pop(),a=t.pop();return(a+e)/sum(t)<.05?t:0==sum(t)?[a,e]:(t.push(a),t.push(e),t)}function determineTerm(t,e){return"Fall"==e||"Summer"==e?e+" "+t.substring(0,4):e+" "+t.substring(0,2)+t.substring(6,8)}function createSubtext(t){return determineTerm(t[0],t[1],!0)+" "+t[5]+" Section "+t[6]+" - "+capitalizeName(t[4])}function adjustLabel(t,e){7==e.length?t.data.labels=["A","B","C","D","F","P","NP"]:5==e.length?t.data.labels=["A","B","C","D","F"]:t.data.labels=["P","NP"]}function replaceData(t,e){t.data.datasets.forEach(t=>{t.data=e})}function gpa(t){if(2==t.length)return(t[0]/sum(t)*100).toFixed(2)+"%";{let e=0,a=0;for(let r=0;r<5;r++)e+=t[r],a+=t[r]*(4-r);return(a/e).toFixed(3)}}function createGPAText(t){return 2==t.length?"Pass rate: "+gpa(t):"Average GPA: "+gpa(t)}function validSearch(){return"All"!=($("#courseTitleInput").val()+$("#instructorInput").val()+$("#courseCodeInput").val()+$("#departmentSelect").val()).trim()}function listClasses(t){$.get("grades.tsv",function(e){for(var a=e.split("\n"),r=0;r<a.length;r++)a[r]=a[r].split("\t");t(trimTSV(a))}).fail(function(){alert("Failed to load classList.dat, please report this error.")})}function createTableEntry(t){metadata='data-year="'+t[0]+'" ',metadata+='data-quarter="'+t[1]+'" ',metadata+='data-dept="'+t[2]+'" ',metadata+='data-number="'+t[3]+'" ',metadata+='data-code="'+t[4]+'" ',metadata+='data-section="'+t[5]+'" ',metadata+='data-title="'+t[6]+'" ',metadata+='data-instructor="'+t[8]+'" ',metadata+='data-a="'+t[9]+'" ',metadata+='data-b="'+t[10]+'" ',metadata+='data-c="'+t[11]+'" ',metadata+='data-d="'+t[12]+'" ',metadata+='data-f="'+t[13]+'" ',metadata+='data-p="'+t[14]+'" ',metadata+='data-np="'+t[15]+'" ';let e="<tr "+metadata+'class="classEntry">';return e+='<td align="center">'+determineTerm(t[0],t[1],!1)+"</td>",e+='<td align="center">'+t[2]+"</td>",e+='<td align="center">'+t[3]+"</td>",e+='<td align="center">'+t[4]+"</td>",e+='<td align="center">'+t[6]+"</td>",e+='<td align="center">'+capitalizeName(t[8])+"</td>",e+="</tr>",$(e)}function buildClassList(){validSearch()?($("#dataInput").hide(),$("#working").show(),listClasses(function(t){if(0==t.length)$("#noResults").show();else for(let e=0;e<t.length;e++)$("#classList").append(createTableEntry(t[e]))}),$("#invalidSearch").hide(),$("#scheduleOfClasses").show()):invalidSearchAlert(),$("#working").hide()}function resetSearch(){$(".box").fadeOut(),$("#yearSelect").val("2018to19"),$("#termSelect").val("All"),$("#departmentSelect").val("All"),$("#courseNumberInput").val(""),$("#courseCodeInput").val(""),$("#instructorInput").val(""),$("#courseTitleInput").val("")}function invalidSearchAlert(t){alert("Invalid search parameters,\nuse at least one of the bold search tools.")}function returnToSearch(){$("tr").remove(".classEntry, .error"),$("#scheduleOfClasses").hide(),$("#noResults").hide(),$("#dataInput").show()}function run(t){let e=determineGrades(t[7]);adjustLabel(chart,e),replaceData(chart,e),$("#class").text(t[3]),$("#subtext").text(createSubtext(t)),$("#average").text(createGPAText(e)),$(".chartTitle").css("visibility","visible"),chart.update()}var targetClassColor,cvs=$("#canvas")[0].getContext("2d"),labels=["A","B","C","D","F","P","NP"],backgroundColor=["rgba(030, 150, 000, 0.5)","rgba(143, 196, 000, 0.5)","rgba(255, 242, 000, 0.5)","rgba(255, 121, 000, 0.5)","rgba(255, 000, 000, 0.5)","rgba(140, 073, 198, 0.5)","rgba(073, 132, 198, 0.5)"],borderColor=["rgba(030, 150, 000, 1)","rgba(143, 196, 000, 1)","rgba(255, 242, 000, 1)","rgba(255, 121, 000, 1)","rgba(255, 000, 000, 1)","rgba(140, 073, 198, 1)","rgba(073, 132, 198, 1)"],chart=new Chart(cvs,{type:"bar",data:{labels:labels,datasets:[{label:"# of Grade",data:[0,0,0,0,0,0,0],backgroundColor:backgroundColor,borderColor:borderColor,borderWidth:1}]},options:{legend:{display:!1},scales:{yAxes:[{gridLines:{color:"rgba(000, 000, 000, .3)"},ticks:{fontSize:18,fontColor:"rgba(000, 000, 000, 1)",beginAtZero:!0}}],xAxes:[{gridLines:{color:"rgba(000, 000, 000, .3)"},ticks:{fontSize:24,fontColor:"rgba(000, 000, 000, 1)"}}]}}}),targetClass=null,highlighted="rgb(255,255,100)";$("table").on("click",function(t){if(row=$(t.target.parentNode),row.hasClass("classEntry")){run([row.data("year"),row.data("quarter"),row.data("code"),row.data("title"),row.data("instructor"),row.data("dept")+" "+row.data("number"),row.data("section"),[row.data("a"),row.data("b"),row.data("c"),row.data("d"),row.data("f"),row.data("p"),row.data("np")]]),null!=targetClass&&targetClass.css("background-color",targetClassColor),targetClass=$(t.target.parentNode),targetClassColor=targetClass.css("background-color"),targetClass.css("background-color",highlighted)}}),$("body").fadeIn();
